<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª â€“ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø®Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-soft: #6366f1;
      --accent: #ec4899;
      --bg: #f3f4f6;
      --card: rgba(255, 255, 255, 0.92);
      --text: #0f172a;
      --muted: #6b7280;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.16);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Cairo", sans-serif;
      background: radial-gradient(circle at top, #e0e7ff 0%, #f9fafb 50%, #f3f4f6 100%);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
      font-size: 18px;
      line-height: 1.8;
    }
    /* ... (Ø§Ø¨Ù‚Ù Ø¹Ù„Ù‰ Ù†ÙØ³ Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) ... */
    .refresh-btn {
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      margin: 15px auto;
      display: block;
      width: 90%;
      max-width: 300px;
      font-size: 18px;
    }
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø®Ø· ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø· */
    a {
      color: #2563eb;
      text-decoration: none;
      font-weight: bold;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <button class="btn refresh-btn" onclick="loadNotes()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
  <div class="app-shell" id="top">
    <!-- ... (Ø§Ø¨Ù‚Ù Ø¹Ù„Ù‰ Ù†ÙØ³ Ù‡ÙŠÙƒÙ„ HTML Ø§Ù„Ø³Ø§Ø¨Ù‚) ... -->
  </div>

  <!-- Modal Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© -->
  <div id="imgModal" class="modal" onclick="hideModal()">
    <button class="modal-close" type="button" onclick="hideModal();event.stopPropagation();">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
    <img id="modalImg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©">
  </div>

  <!-- Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <audio id="dingSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-back-2575.mp3" preload="auto"></audio>

  <script>
    // ================== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ==================
    const scriptURL = "https://script.google.com/macros/s/AKfycbzI1WkE0fUr6HaYiNMBiDn9JfTIByXjCvjQ6jnTyasz5Asyn0mLX4dNrcLVFADVHKMr/exec";
    const nameInput = document.getElementById("name");
    const noteInput = document.getElementById("note");
    const fileInput = document.getElementById("image");
    const fileLabel = document.getElementById("fileLabel");
    const formStatus = document.getElementById("formStatus");
    const sendBtn = document.getElementById("sendBtn");
    const repliesBox = document.getElementById("replies");
    let lastCount = 0;

    // ================== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ==================
    /**
     * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.
     * @param {string} message - Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡Ø§.
     * @param {string} color - Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø§ÙØªØ±Ø§Ø¶ÙŠ: "#4b5563").
     */
    function setStatus(message, color = "#4b5563") {
      formStatus.textContent = message;
      formStatus.style.color = color;
    }

    /**
     * ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù Ø¥Ù„Ù‰ Base64.
     * @param {File} file - Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡.
     * @returns {Promise<string>} - Promise ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ Base64.
     */
    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    /**
     * ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø±.
     * @param {string} text - Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡.
     * @returns {string} - Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·.
     */
    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, (url) => {
        const cleanUrl = url.replace(/[.,!?;:)]$/, "");
        return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer">${cleanUrl}</a>`;
      });
    }

    // ================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶ ==================
    /**
     * Ø¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©.
     * @param {string} src - Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©.
     */
    function showModal(src) {
      const modal = document.getElementById("imgModal");
      const img = document.getElementById("modalImg");
      img.src = src;
      modal.style.display = "flex";
    }

    /**
     * Ø¥Ø®ÙØ§Ø¡ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©.
     */
    function hideModal() {
      const modal = document.getElementById("imgModal");
      modal.style.display = "none";
      document.getElementById("modalImg").src = "";
    }

    /**
     * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¹Ø±Ø¶.
     * @param {string|Date} date - Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙ†Ø³ÙŠÙ‚Ù‡.
     * @returns {string} - Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø³Ù‚.
     */
    function formatDate(date) {
      if (!date) return "";
      try {
        const dt = new Date(date);
        if (isNaN(dt.getTime())) return "";
        return dt.toLocaleString("ar-OM", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });
      } catch {
        return "";
      }
    }

    /**
     * Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯.
     * @param {Object} note - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.
     * @returns {string} - HTML Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©.
     */
    function renderNote(note) {
      const name = note.name || "Ù…Ø¬Ù‡ÙˆÙ„";
      const date = formatDate(note.date);
      const content = linkify((note.note || "").replace(/\n/g, "<br>"));
      const reply = linkify((note.reply || "").replace(/\n/g, "<br>"));
      const image = note.image ? `<img class="note-image" src="${note.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" onclick="showModal('${note.image}')">` : "";
      const replyImage = note.replyImage ? `<img class="reply-image" src="${note.replyImage}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¯" onclick="showModal('${note.replyImage}')">` : "";

      return `
        <article class="note-card">
          <div class="note-header">
            <div>
              <div class="note-name">ğŸ‘¤ ${name}</div>
              <span class="note-badge">ØªÙ… Ø§Ù„Ø±Ø¯</span>
            </div>
            <div class="note-date">${date}</div>
          </div>
          <div class="note-body">${content}</div>
          ${image}
          <div class="reply-box">
            <div class="reply-title">âœ” Ø±Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°:</div>
            <div>${reply}</div>
            ${replyImage}
          </div>
        </article>
      `;
    }

    // ================== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… ==================
    /**
     * Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù….
     */
    async function sendNote() {
      const name = nameInput.value.trim() || "Ù…Ø¬Ù‡ÙˆÙ„";
      const note = noteInput.value.trim();

      if (!note) {
        setStatus("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹.", "#dc2626");
        return;
      }

      let img64 = "";
      const file = fileInput.files[0];

      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          setStatus("âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 5MB.", "#dc2626");
          return;
        }
        try {
          img64 = await toBase64(file);
        } catch (e) {
          setStatus("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©.", "#dc2626");
          return;
        }
      }

      sendBtn.disabled = true;
      setStatus("â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©...", "#4f46e5");

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "add",
            name: name,
            note: note,
            image: img64
          })
        });

        const result = await res.json();

        if (result.success) {
          setStatus("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­.", "#16a34a");
          nameInput.value = "";
          noteInput.value = "";
          fileInput.value = "";
          fileLabel.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©";
          loadReplies();
        } else {
          setStatus(`âŒ Ø®Ø·Ø£: ${result.error || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`, "#dc2626");
        }
      } catch (e) {
        console.error(e);
        setStatus("âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.", "#dc2626");
      } finally {
        sendBtn.disabled = false;
      }
    }

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….
     */
    async function loadReplies() {
      repliesBox.innerHTML = '<div class="empty-state">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...</div>';

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "get" })
        });

        const result = await res.json();

        if (!result.success || !Array.isArray(result.data)) {
          repliesBox.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
          return;
        }

        const replied = result.data.filter(n => n.reply && n.reply.trim() !== "");

        if (replied.length === 0) {
          repliesBox.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø¹Ø¯.</div>';
          return;
        }

        replied.sort((a, b) => (b.row || 0) - (a.row || 0));
        repliesBox.innerHTML = replied.map(renderNote).join("");
        notifyNewNotes(replied.length);
      } catch (e) {
        console.error(e);
        repliesBox.innerHTML = '<div class="empty-state">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</div>';
      }
    }

    /**
     * Ø¥Ø´Ø¹Ø§Ø± ØµÙˆØªÙŠ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.
     * @param {number} currentCount - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
     */
    function notifyNewNotes(currentCount) {
      if (currentCount > lastCount && lastCount !== 0) {
        document.getElementById("dingSound").play();
      }
      lastCount = currentCount;
    }

    // ================== Ø£Ø­Ø¯Ø§Ø« DOM ==================
    fileInput.addEventListener("change", () => {
      fileLabel.textContent = fileInput.files[0] ? fileInput.files[0].name : "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©";
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", () => {
      loadReplies();
      // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 50 Ø«Ø§Ù†ÙŠØ©
      setInterval(loadReplies, 50000);
    });
  </script>
</body>
</html>
