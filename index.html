<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª â€“ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø®Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-soft: #6366f1;
      --accent: #ec4899;
      --bg: #f3f4f6;
      --card: rgba(255, 255, 255, 0.92);
      --text: #0f172a;
      --muted: #6b7280;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.16);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Cairo", sans-serif;
      background: radial-gradient(circle at top, #e0e7ff 0%, #f9fafb 50%, #f3f4f6 100%);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
      font-size: 18px;
      line-height: 1.8;
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø± */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border-radius: var(--radius-md);
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-soft), var(--accent));
      color: white;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
    }

    .refresh-btn {
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      margin: 15px auto;
      display: block;
      width: 90%;
      max-width: 300px;
      font-size: 18px;
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 20px;
    }

    /* ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
    .note-card {
      background: white;
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .note-name {
      font-weight: 600;
      color: var(--primary);
    }

    .note-badge {
      background: #e0e7ff;
      color: var(--primary);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    .note-date {
      color: var(--muted);
      font-size: 12px;
    }

    .note-body {
      margin-top: 10px;
      line-height: 1.6;
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±ÙˆØ§Ø¨Ø· */
    a {
      color: #2563eb;
      text-decoration: none;
      font-weight: bold;
    }

    a:hover {
      text-decoration: underline;
    }

    /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }

    /* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 100;
    }

    .bottom-nav a {
      text-decoration: none;
      color: var(--muted);
      text-align: center;
      font-size: 12px;
    }

    .bottom-nav a.active {
      color: var(--primary);
      font-weight: 600;
    }

    /* ØªØµÙ…ÙŠÙ… Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 16px;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ */
    .list-scroll {
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: var(--radius-md);
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 20px;
    }
  </style>
</head>
<body>

  <div class="app-shell" id="top">
    <header class="app-header">
      <div class="hero-card card">
        <h1 class="hero-title">ğŸ“® ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª â€“ Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</h1>
        <p class="hero-sub">
          Ø£Ø±Ø³Ù„ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø£Ùˆ Ø³Ø¤Ø§Ù„ÙƒØŒ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø®Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ.
        </p>
      </div>
    </header>

    <main class="main-grid">
      <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
      <section class="card" id="sendSection">
        <h2 class="card-title">ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <p class="card-caption">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù…Ù‹Ø§ Ù…Ø³ØªØ¹Ø§Ø±Ù‹Ø§ Ø¥Ù† Ø£Ø­Ø¨Ø¨ØªØŒ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠÙ‡Ù…Ù†Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ø§Ø³Ù….</p>

        <form id="noteForm">
          <div class="form-group">
            <label for="name">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="name" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø·Ø§Ù„Ø¨ Ù…Ø¬ØªÙ‡Ø¯">
          </div>

          <div class="form-group">
            <label for="note">Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© / Ø§Ù„Ø³Ø¤Ø§Ù„</label>
            <textarea id="note" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒØŒ Ø³Ø¤Ø§Ù„ÙƒØŒ Ø±Ø£ÙŠÙƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø³..."></textarea>
          </div>

          <div class="form-group">
            <label>ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" id="image" accept="image/*">
          </div>

          <button type="button" class="btn" id="sendBtn" onclick="sendNote()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ğŸ“¤</button>
          <p id="formStatus" class="status-text"></p>
        </form>
      </section>

      <!-- Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
      <section class="card" id="replySection">
        <h2 class="card-title">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</h2>
        <p class="card-caption">Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø§Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.</p>

        <div id="replies" class="list-scroll">
          <div class="empty-state">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ -->
  <nav class="bottom-nav">
    <a href="#top" class="active">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="#sendSection">ğŸ“ Ø¥Ø±Ø³Ø§Ù„</a>
    <a href="#replySection">ğŸ’¬ Ø§Ù„Ø±Ø¯ÙˆØ¯</a>
    <a href="admin.html">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
  </nav>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© -->
  <div id="imgModal" class="modal" onclick="hideModal()">
    <span class="modal-close" onclick="hideModal();event.stopPropagation();">âœ•</span>
    <img id="modalImg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©">
  </div>

  <!-- Ù…Ù„Ù Ø§Ù„ØµÙˆØª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <audio id="dingSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-back-2575.mp3" preload="auto"></audio>

  <script>
    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    const scriptURL = "https://script.google.com/macros/s/AKfycbzI1WkE0fUr6HaYiNMBiDn9JfTIByXjCvjQ6jnTyasz5Asyn0mLX4dNrcLVFADVHKMr/exec";
    const nameInput = document.getElementById("name");
    const noteInput = document.getElementById("note");
    const fileInput = document.getElementById("image");
    const formStatus = document.getElementById("formStatus");
    const sendBtn = document.getElementById("sendBtn");
    const repliesBox = document.getElementById("replies");
    let lastCount = 0;

    // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
    function setStatus(message, color = "#4b5563") {
      formStatus.textContent = message;
      formStatus.style.color = color;
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function linkify(text) {
      if (!text) return "";
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, (url) => {
        const cleanUrl = url.replace(/[.,!?;:)]$/, "");
        return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer">${cleanUrl}</a>`;
      });
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶
    function showModal(src) {
      const modal = document.getElementById("imgModal");
      const img = document.getElementById("modalImg");
      img.src = src;
      modal.style.display = "flex";
    }

    function hideModal() {
      const modal = document.getElementById("imgModal");
      modal.style.display = "none";
      document.getElementById("modalImg").src = "";
    }

    function formatDate(date) {
      if (!date) return "";
      try {
        const dt = new Date(date);
        if (isNaN(dt.getTime())) return "";
        return dt.toLocaleString("ar-OM", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });
      } catch {
        return "";
      }
    }

    function renderNote(note) {
      const name = note.name || "Ù…Ø¬Ù‡ÙˆÙ„";
      const date = formatDate(note.date);
      const content = linkify((note.note || "").replace(/\n/g, "<br>"));
      const reply = linkify((note.reply || "").replace(/\n/g, "<br>"));
      const image = note.image ? `<img class="note-image" src="${note.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" onclick="showModal('${note.image}')">` : "";
      const replyImage = note.replyImage ? `<img class="reply-image" src="${note.replyImage}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¯" onclick="showModal('${note.replyImage}')">` : "";

      return `
        <article class="note-card">
          <div class="note-header">
            <div>
              <div class="note-name">ğŸ‘¤ ${name}</div>
              <span class="note-badge">ØªÙ… Ø§Ù„Ø±Ø¯</span>
            </div>
            <div class="note-date">${date}</div>
          </div>
          <div class="note-body">${content}</div>
          ${image}
          <div class="reply-box">
            <div class="reply-title">âœ” Ø±Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°:</div>
            <div>${reply}</div>
            ${replyImage}
          </div>
        </article>
      `;
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù…
    async function sendNote() {
      const name = nameInput.value.trim() || "Ù…Ø¬Ù‡ÙˆÙ„";
      const note = noteInput.value.trim();

      if (!note) {
        setStatus("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹.", "#dc2626");
        return;
      }

      let img64 = "";
      const file = fileInput.files[0];

      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          setStatus("âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø± Ù…Ù† 5MB.", "#dc2626");
          return;
        }
        try {
          img64 = await toBase64(file);
        } catch (e) {
          setStatus("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©.", "#dc2626");
          return;
        }
      }

      sendBtn.disabled = true;
      setStatus("â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©...", "#4f46e5");

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "add",
            name: name,
            note: note,
            image: img64
          })
        });

        const result = await res.json();

        if (result.success) {
          setStatus("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­.", "#16a34a");
          nameInput.value = "";
          noteInput.value = "";
          fileInput.value = "";
          loadReplies();
        } else {
          setStatus(`âŒ Ø®Ø·Ø£: ${result.error || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}`, "#dc2626");
        }
      } catch (e) {
        console.error(e);
        setStatus("âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.", "#dc2626");
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function loadReplies() {
      repliesBox.innerHTML = '<div class="empty-state">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...</div>';

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "get" })
        });

        const result = await res.json();

        if (!result.success || !Array.isArray(result.data)) {
          repliesBox.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
          return;
        }

        const replied = result.data.filter(n => n.reply && n.reply.trim() !== "");

        if (replied.length === 0) {
          repliesBox.innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø¹Ø¯.</div>';
          return;
        }

        replied.sort((a, b) => (b.row || 0) - (a.row || 0));
        repliesBox.innerHTML = replied.map(renderNote).join("");
        notifyNewNotes(replied.length);
      } catch (e) {
        console.error(e);
        repliesBox.innerHTML = '<div class="empty-state">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</div>';
      }
    }

    function notifyNewNotes(currentCount) {
      if (currentCount > lastCount && lastCount !== 0) {
        document.getElementById("dingSound").play();
      }
      lastCount = currentCount;
    }

    // Ø£Ø­Ø¯Ø§Ø« DOM
    fileInput.addEventListener("change", () => {
      const fileLabel = document.querySelector("label[for='image']");
      fileLabel.textContent = fileInput.files[0] ? fileInput.files[0].name : "Ø§Ø®ØªØ± ØµÙˆØ±Ø©";
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadReplies();
      setInterval(loadReplies, 50000);
    });
  </script>
</body>
</html>
