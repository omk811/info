<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>

<style>
    body {
        font-family: "Cairo", sans-serif;
        background: #f0f4f8;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
    }

    h1 {
        text-align: center;
        color: #1e40af;
    }

    .login-box, .panel {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    input, textarea {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 15px;
        font-size: 16px;
    }

    button {
        background: #2563eb;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin-left: 5px;
    }

    button:hover {
        background: #1e3a8a;
    }

    .note-card {
        background: #ffffff;
        border-right: 5px solid #2563eb;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 5px 12px rgba(0,0,0,0.08);
        cursor: pointer;
    }

    .note-card.replied {
        border-right-color: #10b981;
        background: #f0fdf4;
    }

    .note-card.pending {
        border-right-color: #f59e0b;
        background: #fff7ed;
    }

    .reply-box {
        padding: 15px;
        background: #e0f7eb;
        border-radius: 10px;
        margin-top: 10px;
    }

    .note-image, .reply-image {
        max-width: 100%;
        border-radius: 10px;
        margin-top: 10px;
    }

    .flex {
        display: flex;
        gap: 20px;
    }

    .notes-list {
        flex: 2;
    }

    .reply-section {
        flex: 1;
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        height: fit-content;
        position: sticky;
        top: 20px;
    }
</style>
</head>

<body>

<div class="container">

<h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h1>

<!-- Login box -->
<div class="login-box" id="loginBox">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <p id="loginStatus" style="color:red; font-weight:600;"></p>
</div>

<!-- Admin Panel -->
<div class="panel" id="adminPanel" style="display:none;">
    
    <button onclick="logout()" style="background:#ef4444;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    <button onclick="loadNotes()">ØªØ­Ø¯ÙŠØ«</button>

    <h2>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>

    <div class="flex">
        <!-- NOTES LIST -->
        <div class="notes-list" id="notesList">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>

        <!-- REPLY SECTION -->
        <div class="reply-section">
            <h3>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h3>

            <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</strong> <span id="selectedName">â€”</span></p>
            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="selectedDate">â€”</span></p>

            <p><strong>Ø§Ù„Ù†Øµ:</strong></p>
            <div id="selectedMessage" style="background:#f3f4f6; padding:10px; border-radius:8px;"></div>

            <div id="selectedImageBox"></div>

            <textarea id="replyText" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯..."></textarea>

            <p>ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ø±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</p>
            <input type="file" id="replyImageInput" accept="image/*">

            <button onclick="sendReply()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
            <button onclick="deleteNote()" style="background:#dc2626;">Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>

            <p id="replyStatus" style="margin-top:10px;"></p>
        </div>
    </div>

</div>

</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwslO8ZjlGHiuvaeKlZrB5czcEbz_so6mqJGnLC9LFF6M_fI-irHDFULd5lcYC_rj8a/exec";

let sessionToken = null;
let selectedRow = null;

/* ---------------------- LOGIN ---------------------- */
async function login() {
    const password = document.getElementById("password").value.trim();
    const loginStatus = document.getElementById("loginStatus");

    loginStatus.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";

    const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
            action: "login",
            password
        })
    });

    const data = await res.json();

    if (data.success) {
        loginStatus.textContent = "";
        sessionToken = data.token;
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadNotes();
    } else {
        loginStatus.textContent = "âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
    }
}

/* ---------------------- LOGOUT ---------------------- */
function logout() {
    sessionToken = null;
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("loginBox").style.display = "block";
}


/* ---------------------- LOAD NOTES ---------------------- */
async function loadNotes() {
    const list = document.getElementById("notesList");
    list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
            action: "getAllNotes",
            token: sessionToken
        })
    });

    const data = await res.json();

    if (!data.success) {
        list.innerHTML = "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
        return;
    }

    let html = "";

    data.data.forEach(n => {
        html += `
        <div class="note-card ${n.reply || n.replyImageURL ? "replied" : "pending"}"
            onclick="selectNote(${n.row})">
            
            <strong>${n.Name}</strong>
            <br>
            <small>${n.date}</small>

            <p>${n.Message}</p>

            ${n.imageURL ? `<img src="${n.imageURL}" class="note-image">` : ""}
        </div>`;
    });

    list.innerHTML = html;
}


/* ---------------------- SELECT NOTE ---------------------- */
function selectNote(row) {
    selectedRow = row;

    fetchNoteDetails(row);
}

async function fetchNoteDetails(row) {
    const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
            action: "getAllNotes",
            token: sessionToken
        })
    });

    const data = await res.json();
    const note = data.data.find(n => n.row === row);

    document.getElementById("selectedName").textContent = note.Name;
    document.getElementById("selectedDate").textContent = note.date;
    document.getElementById("selectedMessage").textContent = note.Message;

    if (note.imageURL) {
        document.getElementById("selectedImageBox").innerHTML =
            `<img src="${note.imageURL}" class="note-image">`;
    } else {
        document.getElementById("selectedImageBox").innerHTML = "";
    }
}

/* ---------------------- SEND REPLY ---------------------- */
async function sendReply() {
    if (!selectedRow) return;

    const replyText = document.getElementById("replyText").value.trim();
    const replyFile = document.getElementById("replyImageInput").files[0];
    const replyStatus = document.getElementById("replyStatus");

    replyStatus.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    let replyImage64 = "";
    if (replyFile) {
        const reader = new FileReader();
        replyImage64 = await new Promise(resolve => {
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(replyFile);
        });
    }

    const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
            action: "updateNote",
            row: selectedRow,
            reply: replyText,
            replyImage: replyImage64,
            token: sessionToken
        })
    });

    const data = await res.json();

    if (data.success) {
        replyStatus.style.color = "green";
        replyStatus.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯";
        loadNotes();
    } else {
        replyStatus.style.color = "red";
        replyStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
    }
}

/* ---------------------- DELETE NOTE ---------------------- */
async function deleteNote() {
    if (!selectedRow) return;

    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ")) return;

    const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
            action: "deleteNote",
            row: selectedRow,
            token: sessionToken
        })
    });

    const data = await res.json();

    if (data.success) {
        alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
        loadNotes();
    } else {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
    }
}
</script>

</body>
</html>
