<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª â€“ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø®Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg:#f0f2f5;
  --panel:#ffffff;
  --blue:#0084ff;
  --green:#10b981;
  --border:#dcdcdc;
  --text:#1e293b;
}

body.dark {
  --bg:#121b22;
  --panel:#1f2c33;
  --border:#2c3d45;
  --text:#e9edef;
}

body {
  margin:0;
  background:var(--bg);
  font-family:"Cairo",sans-serif;
  color:var(--text);
  overflow:hidden;
}

.top {
  background:var(--panel);
  padding:14px;
  font-size:20px;
  font-weight:700;
  color:var(--text);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.mode-btn {
  background:none;
  border:none;
  font-size:22px;
  cursor:pointer;
  color:var(--text);
}

.main {
  height:calc(100vh - 60px);
  display:flex;
}

/* Left Panel = Chat List */
.left {
  width:32%;
  background:var(--panel);
  border-left:1px solid var(--border);
  overflow-y:auto;
}

.item {
  padding:14px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
}

.item:hover { background:#e6e9eb33; }

.item-name { font-weight:700; }
.item-msg { font-size:14px; color:#666; }

/* Right Panel = Chat Window */
.right {
  width:68%;
  display:flex;
  flex-direction:column;
  border-right:1px solid var(--border);
}

.chat-window {
  flex:1;
  padding:20px;
  overflow-y:auto;
}

.msg-box {
  background:white;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  max-width:90%;
  line-height:1.6;
}

img {
  width:100%;
  border-radius:10px;
  margin-top:10px;
}

/* reply bubble */
.reply-bubble {
  background:#e6f7ff;
  border-right:4px solid var(--blue);
  padding:12px;
  border-radius:10px;
  margin-top:12px;
}

.bottom {
  padding:16px;
  background:var(--panel);
  display:flex;
  flex-direction:column;
  border-top:1px solid var(--border);
}

textarea {
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:15px;
  background:#f8fafc;
  margin-bottom:10px;
}

button {
  padding:12px;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:12px;
  cursor:pointer;
  background:var(--blue);
  color:white;
}

.delete-btn {
  background:#dc2626;
  margin-top:8px;
}

</style>
</head>

<body>

<div class="top">
  Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  <button class="mode-btn" onclick="toggleMode()">ğŸŒ™</button>
</div>

<div class="main">
  <div class="left" id="listBox"></div>

  <div class="right">
    <div class="chat-window" id="chatWindow">
      <p style="color:#888;">Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©â€¦</p>
    </div>

    <div class="bottom">
      <textarea id="replyText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯â€¦"></textarea>
      <input type="file" id="replyImg" accept="image/*" style="margin-bottom:10px;">
      <button onclick="sendReply()">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
      <button class="delete-btn" onclick="deleteNote()">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
    </div>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxfK_7ByFDvHAEj8d-jqd6rPYWQivXNk9sE9bwjM6iDYNGLiu6h59x1G5X42X3XNeIh/exec";
let notes = [];
let currentIndex = null;

/* Mode Switch */
function toggleMode(){
  document.body.classList.toggle("dark");
}

/* Load Notes */
async function loadNotes(){
  const res = await fetch(scriptURL + "?getData");
  notes = await res.json();
  renderList();
}

function renderList(){
  const box = document.getElementById("listBox");
  box.innerHTML = "";

  notes.forEach((n,i)=>{
    box.innerHTML += `
      <div class="item" onclick="openNote(${i})">
        <div class="item-name">${n.name}</div>
        <div class="item-msg">${n.message.substring(0,25)}...</div>
      </div>
    `;
  });
}

function openNote(i){
  currentIndex = i;
  const n = notes[i];
  const chat = document.getElementById("chatWindow");

  let html = `
    <div class='msg-box'>
      <b>${n.name}</b><br>${n.message}
      ${n.image ? `<img src='${n.image.split('"')[1]}'>` : ""}
    </div>
  `;

  if (n.reply || n.replyImage){
    html += `
      <div class="reply-bubble">
        ${n.reply ? `<b>Ø±Ø¯ Ø§Ù„Ù…Ø´Ø±Ù:</b><br>${n.reply}<br>` : ""}
        ${n.replyImage ? `<img src='${n.replyImage.split('"')[1]}'>` : ""}
      </div>
    `;
  }

  chat.innerHTML = html;
}

/* Send Reply */
async function sendReply(){
  if (currentIndex === null) return alert("Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹");

  const reply = document.getElementById("replyText").value.trim();
  const file = document.getElementById("replyImg").files[0];

  if (!reply && !file) return alert("Ø§Ù„Ø±Ø¯ ÙØ§Ø±Øº");

  let base64 = "";
  if (file){
    const r = new FileReader();
    r.onloadend = ()=> submitReply(reply, r.result);
    r.readAsDataURL(file);
  } else {
    submitReply(reply, "");
  }
}

async function submitReply(reply, img){
  await fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify({
      type:"reply",
      row: notes[currentIndex].row,
      reply,
      replyImage: img
    })
  });

  document.getElementById("replyText").value = "";
  document.getElementById("replyImg").value = "";
  loadNotes();
  openNote(currentIndex);
}

/* Delete Note */
async function deleteNote(){
  if (currentIndex === null) return alert("Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø©");

  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) return;

  await fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify({
      type:"delete",
      row: notes[currentIndex].row
    })
  });

  currentIndex = null;
  loadNotes();
  document.getElementById("chatWindow").innerHTML = "<p>ØªÙ… Ø§Ù„Ø­Ø°Ù</p>";
}

/* Initialize */
loadNotes();
</script>

</body>
</html>
