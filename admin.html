<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">

  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª â€“ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø®Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #4f46e5;
      --primary-soft: #6366f1;
      --accent: #ec4899;
      --bg: #f3f4f6;
      --card: rgba(255, 255, 255, 0.98);
      --text: #0f172a;
      --muted: #6b7280;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-soft: 0 20px 50px rgba(15, 23, 42, 0.32);
    }

    body.dark {
      --bg: #020617;
      --card: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --primary: #818cf8;
      --primary-soft: #a855f7;
      --accent: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Cairo", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0%, var(--bg) 60%);
      color: var(--text);
      min-height: 100vh;
      padding: 14px;
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .title-chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(79,70,229,0.18), rgba(236,72,153,0.18));
      font-size: 12px;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.4);
    }

    .dark-toggle {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.86);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .back-link {
      padding: 7px 12px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.45);
      font-size: 12px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .login-card {
      max-width: 420px;
      margin: 60px auto;
      padding: 20px 18px 22px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top, rgba(79, 70, 229, 0.45), rgba(15, 23, 42, 0.95));
      color: #f9fafb;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    .login-title {
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
    }

    .login-sub {
      font-size: 12px;
      text-align: center;
      opacity: 0.9;
      margin-bottom: 12px;
    }

    .login-card input {
      width: 100%;
      padding: 11px 12px;
      border-radius: var(--radius-md);
      border: none;
      font-size: 14px;
      margin-top: 6px;
      background: rgba(15,23,42,0.85);
      color: #f9fafb;
      outline: none;
      box-shadow: 0 0 0 1px rgba(148,163,184,0.7);
    }

    .login-btn {
      width: 100%;
      margin-top: 12px;
      padding: 11px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, var(--primary-soft), var(--accent));
      color: #f9fafb;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.5);
    }

    .login-status {
      font-size: 12px;
      text-align: center;
      margin-top: 8px;
      min-height: 16px;
      color: #fed7aa;
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
    .dashboard {
      margin-top: 6px;
      padding: 16px 14px 18px;
      border-radius: var(--radius-lg);
      background: var(--card);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    .header-title {
      font-size: 17px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-chip {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #f1f5f9;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .stat-chip strong {
      color: var(--primary);
      font-weight: 700;
    }

    /* ØªØ®Ø·ÙŠØ· Ø±Ø¦ÙŠØ³ÙŠ: Ù‚Ø§Ø¦Ù…Ø© + Ø±Ø¯ */
    .layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 840px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .column {
      flex: 1;
      min-width: 0;
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
    .list-panel {
      border-radius: var(--radius-md);
      background: rgba(248, 250, 252, 0.95);
      padding: 10px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      max-height: 70vh;
      overflow-y: auto;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .filters input {
      flex: 1.5;
      min-width: 150px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      background: #e5e7eb;
      outline: none;
    }

    .filter-btn {
      padding: 6px 8px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      cursor: pointer;
      background: #e5e7eb;
      color: #475569;
      white-space: nowrap;
    }

    .filter-btn.active {
      background: var(--primary);
      color: #f9fafb;
    }

    .notes-list {
      margin-top: 6px;
    }

    .note-item {
      border-radius: 14px;
      padding: 8px 9px;
      margin-bottom: 8px;
      background: #ffffff;
      border-right: 4px solid var(--primary);
      box-shadow: 0 4px 10px rgba(15,23,42,0.12);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s;
    }

    .note-item.replied {
      border-right-color: #16a34a;
    }

    .note-item.new {
      border-right-color: #f97316;
    }

    .note-item:hover {
      transform: translateX(-3px);
      box-shadow: 0 8px 16px rgba(15,23,42,0.22);
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .note-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .note-date {
      color: var(--muted);
      white-space: nowrap;
    }

    .note-snippet {
      font-size: 12px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .note-status {
      font-size: 10px;
      margin-top: 3px;
      padding: 3px 7px;
      border-radius: 999px;
      display: inline-block;
      background: #e5e7eb;
      color: #475569;
    }

    .note-status.replied {
      background: #dcfce7;
      color: #166534;
    }

    .note-status.new {
      background: #fef3c7;
      color: #92400e;
    }

    .empty-list {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      padding: 14px 4px;
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¯ */
    .reply-panel {
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.02);
      padding: 10px;
      border: 1px solid rgba(226, 232, 240, 0.8);
      max-height: 70vh;
      overflow-y: auto;
    }

    .selected-note-box {
      border-radius: 14px;
      padding: 9px 10px;
      background: #ffffff;
      box-shadow: 0 4px 14px rgba(15,23,42,0.18);
      margin-bottom: 10px;
      font-size: 13px;
      white-space: pre-wrap;
      color: var(--text);
    }

    .selected-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 4px;
    }

    .selected-name {
      font-weight: 600;
    }

    .selected-date {
      font-size: 11px;
      color: var(--muted);
    }

    .selected-text {
      margin-top: 4px;
    }

    .selected-note-box img {
      margin-top: 6px;
      border-radius: 12px;
      width: 100%;
      max-height: 260px;
      object-fit: contain;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(15,23,42,0.25);
    }

    .previous-reply {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      background: #ecfdf5;
      color: #064e3b;
      font-size: 12px;
    }

    .form-group {
      margin-top: 6px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
      font-weight: 600;
      color: var(--text);
    }

    textarea,
    input[type="file"] {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
    }

    textarea {
      padding: 8px 9px;
      border-radius: var(--radius-md);
      border: none;
      background: #e5e7eb;
      resize: vertical;
      min-height: 70px;
      max-height: 200px;
      outline: none;
    }

    textarea:focus {
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.4);
      background: #e0e7ff;
    }

    input[type="file"] {
      font-size: 11px;
      margin-top: 2px;
    }

    .reply-btn {
      width: 100%;
      margin-top: 8px;
      padding: 9px 10px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, var(--primary-soft), var(--accent));
      color: #f9fafb;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(15,23,42,0.45);
    }

    .reply-status {
      font-size: 11px;
      color: var(--muted);
      margin-top: 5px;
      min-height: 16px;
    }

    /* Modal Ø§Ù„ØµÙˆØ±Ø© */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal img {
      max-width: 95vw;
      max-height: 90vh;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.85);
    }

    .modal-close {
      position: absolute;
      top: 14px;
      inset-inline-start: 16px;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    /* Scrollbars Ø®ÙÙŠÙØ© */
    .list-panel::-webkit-scrollbar,
    .reply-panel::-webkit-scrollbar {
      width: 4px;
    }

    .list-panel::-webkit-scrollbar-thumb,
    .reply-panel::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.9);
      border-radius: 999px;
    }
    /* === ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„Ø®Ø· ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© === *//* === ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© === */
body {
  font-size: 17px;
}

.header-title {
  font-size: 22px;
}

.note-item,
.selected-note-box,
textarea,
.reply-btn {
  font-size: 17px;
}

.note-date,
.note-status {
  font-size: 14px;
}

.reply-status { 
  font-size: 15px; 
}

/* Ø§Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 600px) {
  body { font-size: 18px; }
  .header-title { font-size: 23px; }
  textarea { font-size: 18px; }
  .reply-btn { font-size: 18px; }
}
.admin-refresh {
  background: linear-gradient(135deg, #10b981, #059669);
  margin: 10px 0;
  width: 100%;
  font-size: 17px;
}
}
  </style>
</head>
<body>

<div class="app-shell">

  <div class="top-bar">
    <div class="top-left">
      <span class="title-chip">âš™ï¸ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ØµÙ†Ø¯ÙˆÙ‚ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</span>
      <button class="dark-toggle" type="button" onclick="toggleDark()">
        ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹
      </button>
    </div>
    <a href="index.html" class="back-link">
      â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </a>
  </div>
<button class="btn admin-refresh" onclick="loadNotes()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="loginScreen" class="login-card">
    <div class="login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    <div class="login-sub">
      Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø³ØªØ§Ø° Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.
    </div>
    <label for="pass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="pass" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©">
    <button class="login-btn" type="button" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginStatus" class="login-status"></div>
  </section>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
  <section id="adminScreen" class="dashboard" style="display:none;">
    <div class="header-row">
      <div>
        <div class="header-title">
          <span>ğŸ“‹</span><span>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯</span>
        </div>
        <p class="header-sub">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø«ØŒ ØªØµÙÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.</p>
      </div>
      <div id="statsText" class="header-sub"></div>
    </div>

    <div class="stats-row">
      <span class="stat-chip">ğŸ“„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="statTotal">0</strong></span>
      <span class="stat-chip">ğŸ†• Ø¬Ø¯ÙŠØ¯Ø©: <strong id="statNew">0</strong></span>
      <span class="stat-chip">âœ… ØªÙ… Ø§Ù„Ø±Ø¯: <strong id="statReplied">0</strong></span>
      <span class="stat-chip">ğŸ–¼ Ø¨Ù‡Ø§ ØµÙˆØ±Ø©: <strong id="statImage">0</strong></span>
    </div>

    <div class="layout">
      <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
      <div class="column">
        <div class="list-panel">
          <div class="filters">
            <input id="searchInput" type="text" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©..." oninput="renderNotes()">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all', this)">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" data-filter="new" onclick="setFilter('new', this)">Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="filter-btn" data-filter="replied" onclick="setFilter('replied', this)">ØªÙ… Ø§Ù„Ø±Ø¯</button>
            <button class="filter-btn" data-filter="image" onclick="setFilter('image', this)">Ø¨Ù‡Ø§ ØµÙˆØ±Ø©</button>
          </div>
          <div id="notesList" class="notes-list"></div>
        </div>
      </div>

      <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¯ -->
      <div class="column">
        <div class="reply-panel">
          <div class="selected-note-box" id="selectedBox">
            Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø¹Ø¯. Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§.
          </div>

          <div class="form-group">
            <label for="replyText">Ù†Øµ Ø§Ù„Ø±Ø¯</label>
            <textarea id="replyText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ Ù…Ø¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø§Ø¨."></textarea>
          </div>

          <div class="form-group">
            <label for="replyImage">ØµÙˆØ±Ø© Ù„Ù„Ø±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="file" id="replyImage" accept="image/*">
          </div>

          <button class="reply-btn" type="button" onclick="sendReply()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
          <div id="replyStatus" class="reply-status"></div>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- Modal Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© -->
<div id="imgModal" class="modal" onclick="hideModal()">
  <button class="modal-close" type="button" onclick="hideModal();event.stopPropagation();">Ø¥ØºÙ„Ø§Ù‚ âœ•</button>
  <img id="modalImg" alt="">
</div>

<script>
  const PASSWORD = "aysha123";
  const scriptURL = "https://script.google.com/macros/s/AKfycbzI1WkE0fUr6HaYiNMBiDn9JfTIByXjCvjQ6jnTyasz5Asyn0mLX4dNrcLVFADVHKMr/exec";

  let allNotes = [];
  let currentFilter = "all";
  let selectedNote = null;

  const loginScreen = document.getElementById("loginScreen");
  const adminScreen = document.getElementById("adminScreen");
  const loginStatus = document.getElementById("loginStatus");
  const passInput = document.getElementById("pass");

  const notesList = document.getElementById("notesList");
  const searchInput = document.getElementById("searchInput");

  const statTotal = document.getElementById("statTotal");
  const statNew = document.getElementById("statNew");
  const statReplied = document.getElementById("statReplied");
  const statImage = document.getElementById("statImage");
  const statsText = document.getElementById("statsText");

  const selectedBox = document.getElementById("selectedBox");
  const replyText = document.getElementById("replyText");
  const replyImage = document.getElementById("replyImage");
  const replyStatus = document.getElementById("replyStatus");

  function toggleDark() {
    document.body.classList.toggle("dark");
  }

  function login() {
    const value = passInput.value.trim();
    if (value === PASSWORD) {
      loginStatus.textContent = "";
      loginScreen.style.display = "none";
      adminScreen.style.display = "block";
      loadNotes();
    } else {
      loginStatus.textContent = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
    }
  }

  passInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") login();
  });

  async function loadNotes() {
    notesList.innerHTML = '<div class="empty-list">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...</div>';

    try {
      const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({ type: "get" })
      });
      const result = await res.json();

      if (!result.success || !Array.isArray(result.data)) {
        notesList.innerHTML = '<div class="empty-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©.</div>';
        return;
      }

      allNotes = result.data.sort((a, b) => (b.row || 0) - (a.row || 0));
      updateStats();
      renderNotes();
    } catch (e) {
      console.error(e);
      notesList.innerHTML = '<div class="empty-list">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.</div>';
    }
  }

  function updateStats() {
    const total = allNotes.length;
    const replied = allNotes.filter(n => n.reply && n.reply.trim() !== "").length;
    const newOnes = total - replied;
    const withImage = allNotes.filter(n => n.image && n.image.trim() !== "").length;

    statTotal.textContent = total;
    statNew.textContent = newOnes;
    statReplied.textContent = replied;
    statImage.textContent = withImage;

    statsText.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total} Ù…Ù„Ø§Ø­Ø¸Ø© | ${newOnes} Ø¬Ø¯ÙŠØ¯Ø© | ${replied} ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§`;
  }

  function setFilter(type, btn) {
    currentFilter = type;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderNotes();
  }

  function renderNotes() {
    const query = searchInput.value.trim().toLowerCase();

    let list = allNotes.slice();

    if (currentFilter === "new") {
      list = list.filter(n => !n.reply || n.reply.trim() === "");
    } else if (currentFilter === "replied") {
      list = list.filter(n => n.reply && n.reply.trim() !== "");
    } else if (currentFilter === "image") {
      list = list.filter(n => n.image && n.image.trim() !== "");
    }

    if (query) {
      list = list.filter(n =>
        (n.name || "").toLowerCase().includes(query) ||
        (n.note || "").toLowerCase().includes(query)
      );
    }

    if (list.length === 0) {
      notesList.innerHTML = '<div class="empty-list">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>';
      return;
    }

    let html = "";
    list.forEach(n => {
      const hasReply = n.reply && n.reply.trim() !== "";
      const hasImage = n.image && n.image.trim() !== "";
      const cls = hasReply ? "replied" : "new";
      const snippet = (n.note || "").replace(/\s+/g, " ").slice(0, 80);
      html += `
        <article class="note-item ${cls}" onclick="selectNote(${n.row})">
          <div class="note-header">
            <div class="note-name">
              <span>ğŸ‘¤</span><span>${n.name || "Ù…Ø¬Ù‡ÙˆÙ„"}</span>
            </div>
            <div class="note-date">${formatDateShort(n.date)}</div>
          </div>
          <div class="note-snippet">${snippet}${(n.note || "").length > 80 ? "..." : ""}</div>
          <div class="note-status ${cls}">
            ${hasReply ? "ØªÙ… Ø§Ù„Ø±Ø¯" : "Ø¬Ø¯ÙŠØ¯Ø©"}${hasImage ? " â€¢ ğŸ–¼" : ""}
          </div>
        </article>
      `;
    });

    notesList.innerHTML = html;
  }

  function selectNote(row) {
    const n = allNotes.find(x => Number(x.row) === Number(row));
    if (!n) return;
    selectedNote = n;

    let html = `
      <div class="selected-header">
        <div class="selected-name">ğŸ‘¤ ${n.name || "Ù…Ø¬Ù‡ÙˆÙ„"}</div>
        <div class="selected-date">${formatDateLong(n.date)}</div>
      </div>
      <div class="selected-text">${(n.note || "").replace(/\n/g, "<br>")}</div>
    `;

    if (n.image) {
      html += `<img src="${n.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©" onclick="showModal('${n.image}')">`;
    }

    if (n.reply || n.replyImage) {
      html += `
        <div class="previous-reply">
          <strong>âœ” Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚:</strong><br>
          ${(n.reply || "").replace(/\n/g, "<br>")}
          ${n.replyImage ? `<br><img src="${n.replyImage}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¯" onclick="showModal('${n.replyImage}')">` : ""}
        </div>
      `;
    }

    selectedBox.innerHTML = html;
    replyText.value = n.reply || "";
    replyImage.value = "";
    replyStatus.textContent = "";
  }

  async function sendReply() {
    if (!selectedNote) {
      replyStatus.textContent = "âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ø§Ø­Ø¸Ø© Ø£ÙˆÙ„Ø§Ù‹.";
      return;
    }

    const reply = replyText.value.trim();
    const file = replyImage.files[0];

    if (!reply && !file) {
      replyStatus.textContent = "âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø£Ùˆ Ø£Ø±ÙÙ‚ ØµÙˆØ±Ø©.";
      return;
    }

    let img64 = "";
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        replyStatus.textContent = "âŒ Ø­Ø¬Ù… ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¯ Ø£ÙƒØ¨Ø± Ù…Ù† 5MB.";
        return;
      }
      img64 = await toBase64(file);
    }

    replyStatus.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø¯...";
    try {
      const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify({
          type: "reply",
          row: selectedNote.row,
          reply: reply,
          replyImage: img64
        })
      });
      const result = await res.json();

      if (result.success) {
        replyStatus.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­.";
        loadNotes();
      } else {
        replyStatus.textContent = "âŒ Ø®Ø·Ø£: " + (result.error || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
      }
    } catch (e) {
      console.error(e);
      replyStatus.textContent = "âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….";
    }
  }

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  function formatDateShort(d) {
    if (!d) return "";
    try {
      const dt = new Date(d);
      if (isNaN(dt.getTime())) return "";
      return dt.toLocaleDateString("ar-OM", {
        month: "short",
        day: "numeric"
      });
    } catch {
      return "";
    }
  }

  function formatDateLong(d) {
    if (!d) return "";
    try {
      const dt = new Date(d);
      if (isNaN(dt.getTime())) return "";
      return dt.toLocaleString("ar-OM", {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });
    } catch {
      return "";
    }
  }

  function showModal(src) {
    const modal = document.getElementById("imgModal");
    const img = document.getElementById("modalImg");
    img.src = src;
    modal.style.display = "flex";
  }

  function hideModal() {
    const modal = document.getElementById("imgModal");
    modal.style.display = "none";
    document.getElementById("modalImg").src = "";
  }
</script>

</body>
</html>