<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€“ Ø§Ù„Ø£Ø³ØªØ§Ø° Ø®Ù„ÙŠÙ„ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f0f2f5;
  --panel:#ffffff;
  --border:#dcdcdc;
  --blue:#0084ff;
  --text:#1e293b;
}

body.dark{
  --bg:#121b22;
  --panel:#1f2c33;
  --border:#3c4b55;
  --text:#e9edef;
}

body{
  margin:0;
  background:var(--bg);
  font-family:"Cairo",sans-serif;
  color:var(--text);
  overflow:hidden;
}

.top{
  background:var(--panel);
  padding:14px;
  font-size:20px;
  font-weight:700;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
}

.mode{
  font-size:22px;
  cursor:pointer;
  background:none;
  border:none;
  color:var(--text);
}

.main{
  height:calc(100vh - 60px);
  display:flex;
}

.left{
  width:32%;
  background:var(--panel);
  border-left:1px solid var(--border);
  overflow-y:auto;
}

.item{
  padding:14px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
}

.item:hover{
  background:#eaeaea55;
}

.item-name{
  font-weight:700;
}

.item-msg{
  color:#777;
  font-size:14px;
}

.right{
  width:68%;
  display:flex;
  flex-direction:column;
}

.chat{
  flex:1;
  padding:20px;
  overflow-y:auto;
}

.msg-box{
  background:var(--panel);
  padding:16px;
  border-radius:12px;
  margin-bottom:12px;
  line-height:1.7;
}

img{
  width:100%;
  border-radius:10px;
  margin-top:10px;
  max-height:300px;
  object-fit:contain;
}

.reply{
  background:#e6f7ff;
  border-right:4px solid var(--blue);
  padding:12px;
  margin-top:12px;
  border-radius:10px;
}

.bottom{
  padding:14px;
  background:var(--panel);
  border-top:1px solid var(--border);
}

textarea{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:15px;
  background:#f8fafc;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  margin-top:10px;
  background:var(--blue);
  color:white;
  font-size:17px;
  font-weight:700;
  cursor:pointer;
}

.delete{
  background:#dc2626;
}
</style>
</head>

<body>

<div class="top">
  Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  <button class="mode" onclick="toggle()">ğŸŒ™</button>
</div>

<div class="main">
  <div class="left" id="listBox"></div>

  <div class="right">
    <div class="chat" id="chatWindow">
      <p style="color:#888;">Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©â€¦</p>
    </div>

    <div class="bottom">
      <textarea id="replyText" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯â€¦"></textarea>
      <input id="replyImg" type="file" accept="image/*" style="margin-top:10px;">
      <button onclick="sendReply()">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
      <button class="delete" onclick="deleteNote()">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
    </div>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxfK_7ByFDvHAEj8d-jqd6rPYWQivXNk9sE9bwjM6iDYNGLiu6h59x1G5X42X3XNeIh/exec";

let notes = [];
let current = null;

/* Dark mode toggle */
function toggle(){
  document.body.classList.toggle("dark");
}

/* Load notes */
async function load(){
  const res = await fetch(scriptURL + "?getData");
  notes = await res.json();
  renderList();
}

function renderList(){
  let box = document.getElementById("listBox");
  box.innerHTML = "";

  notes.forEach((n,i)=>{
    box.innerHTML += `
      <div class="item" onclick="openNote(${i})">
        <div class="item-name">${n.name}</div>
        <div class="item-msg">${n.message.substring(0,25)}...</div>
      </div>
    `;
  });
}

function openNote(i){
  current = i;
  const n = notes[i];
  const chat = document.getElementById("chatWindow");

  let html = `
    <div class="msg-box">
      <b>${n.name}</b><br>${n.message}
      ${n.image ? `<img src="${n.image}">` : ""}
    </div>
  `;

  if(n.reply || n.replyImage){
    html += `<div class="reply">`;
    if(n.reply) html += `<b>Ø±Ø¯ Ø§Ù„Ù…Ø´Ø±Ù:</b><br>${n.reply}<br>`;
    if(n.replyImage) html += `<img src="${n.replyImage}">`;
    html += `</div>`;
  }

  chat.innerHTML = html;
}

/* Send reply */
async function sendReply(){
  if(current === null) return alert("Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø©");

  const reply = document.getElementById("replyText").value.trim();
  const file = document.getElementById("replyImg").files[0];

  if(!reply && !file) return alert("Ø§Ù„Ø±Ø¯ ÙØ§Ø±Øº");

  if(file){
    const r = new FileReader();
    r.onloadend = ()=> submitReply(reply, r.result);
    r.readAsDataURL(file);
  } else {
    submitReply(reply, "");
  }
}

async function submitReply(text, img){
  await fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify({
      type:"reply",
      row: notes[current].row,
      reply: text,
      replyImage: img
    })
  });

  document.getElementById("replyText").value = "";
  document.getElementById("replyImg").value = "";

  load();
  openNote(current);
}

/* Delete note */
async function deleteNote(){
  if(current === null) return alert("Ø§Ø®ØªØ± Ù…Ù„Ø§Ø­Ø¸Ø©");

  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) return;

  await fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify({
      type:"delete",
      row: notes[current].row
    })
  });

  document.getElementById("chatWindow").innerHTML = "<p>ØªÙ… Ø§Ù„Ø­Ø°Ù</p>";
  load();
  current = null;
}

/* Init */
load();
</script>

</body>
</html>
